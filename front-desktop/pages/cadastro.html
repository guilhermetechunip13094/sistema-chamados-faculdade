<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Criar Conta — Sistema de Chamados</title>
    <link rel="stylesheet" href="../assets/css/style.css" />
    <link rel="stylesheet" href="../assets/css/responsive.css" />
    <link rel="stylesheet" href="../assets/css/contrast-fixes.css" />
      @media (max-width: 600px) {
        .form-row {
          grid-template-columns: 1fr;
        }
      }
      .input-error {
        border-color: #fc8181 !important;
      }
      .field-error {
        color: #c53030;
        font-size: 12px;
        margin-top: 4px;
        display: none;
      }
      .field-error.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Header: navegação entre login/cadastro -->
      <header class="header">
        <div class="wrap">
          <div class="brand">
            <h1 class="text-center">Sistema de Chamados</h1>
          </div>
          <nav>
            <a href="login.html">Login</a>
            <a class="active" href="cadastro.html">Criar conta</a>
          </nav>
        </div>
      </header>

      <!-- Conteúdo principal: formulário de cadastro -->
      <main class="main centered">
        <div class="auth-box">
          <div class="auth-title text-center">Nova Conta</div>

          <!-- Mensagens de erro/sucesso -->
          <div id="alert" class="alert"></div>

          <!-- Formulário de cadastro integrado com API -->
          <form id="register-form" novalidate>
            <div class="form-group">
              <label for="r-name">Nome completo</label>
              <input
                id="r-name"
                type="text"
                placeholder="Seu nome completo"
                required
                autocomplete="name"
                aria-required="true"
              />
              <div id="name-error" class="field-error"></div>
            </div>

            <div class="form-group">
              <label for="r-email">E-mail</label>
              <input
                id="r-email"
                type="email"
                placeholder="voce@email.com"
                required
                autocomplete="email"
                aria-required="true"
              />
              <div id="email-error" class="field-error"></div>
            </div>

            <div class="form-row">
              <div class="form-group password-group">
                <label for="r-pass">Senha</label>
                <div class="password-wrapper">
                  <input
                    id="r-pass"
                    type="password"
                    placeholder="••••••••"
                    required
                    minlength="6"
                    autocomplete="new-password"
                    aria-required="true"
                  />
                  <button
                    type="button"
                    class="toggle-btn"
                    data-target="r-pass"
                    aria-label="Mostrar/ocultar senha"
                  >
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path
                        d="M12 4.5C7 4.5 2.7 7.6 1 12c1.7 4.4 6 7.5 11 7.5s9.3-3.1 11-7.5c-1.7-4.4-6-7.5-11-7.5zM12 17a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"
                      />
                      <circle cx="12" cy="12" r="3" />
                    </svg>
                  </button>
                </div>
                <div id="pass-error" class="field-error"></div>
              </div>

              <div class="form-group password-group">
                <label for="r-pass-confirm">Confirmar senha</label>
                <div class="password-wrapper">
                  <input
                    id="r-pass-confirm"
                    type="password"
                    placeholder="••••••••"
                    required
                    minlength="6"
                    autocomplete="new-password"
                    aria-required="true"
                  />
                  <button
                    type="button"
                    class="toggle-btn"
                    data-target="r-pass-confirm"
                    aria-label="Mostrar/ocultar senha de confirmação"
                  >
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path
                        d="M12 4.5C7 4.5 2.7 7.6 1 12c1.7 4.4 6 7.5 11 7.5s9.3-3.1 11-7.5c-1.7-4.4-6-7.5-11-7.5zM12 17a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"
                      />
                      <circle cx="12" cy="12" r="3" />
                    </svg>
                  </button>
                </div>
                <div id="pass-confirm-error" class="field-error"></div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="r-cpf">CPF</label>
                <input
                  id="r-cpf"
                  type="text"
                  placeholder="000.000.000-00"
                  required
                  maxlength="14"
                  aria-required="true"
                />
                <div id="cpf-error" class="field-error"></div>
              </div>

              <div class="form-group">
                <label for="r-phone">Telefone</label>
                <input
                  id="r-phone"
                  type="tel"
                  placeholder="(00) 00000-0000"
                  required
                  maxlength="15"
                  autocomplete="tel"
                  aria-required="true"
                />
                <div id="phone-error" class="field-error"></div>
              </div>
            </div>

            <button type="submit" class="btn btn-primary btn-block" id="register-btn">
              <span id="register-text">Criar Conta</span>
            </button>
          </form>

          <div class="auth-footer text-center">
            Já tem uma conta? <a href="login.html">Fazer login</a>
          </div>
        </div>
      </main>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/loading.js"></script>
    <script src="../assets/js/toast.js"></script>
    <script src="../assets/js/accessibility.js"></script>
    <script>
      // Inicializar gerenciadores
      const loader = new LoadingManager()
      const toaster = new ToastManager()
      const a11y = new AccessibilityManager()
      
      // Máscaras para CPF e Telefone
      function maskCPF(value) {
        return value
          .replace(/\D/g, '')
          .replace(/(\d{3})(\d)/, '$1.$2')
          .replace(/(\d{3})(\d)/, '$1.$2')
          .replace(/(\d{3})(\d{1,2})/, '$1-$2')
          .replace(/(-\d{2})\d+?$/, '$1')
      }

      function maskPhone(value) {
        return value
          .replace(/\D/g, '')
          .replace(/(\d{2})(\d)/, '($1) $2')
          .replace(/(\d{5})(\d)/, '$1-$2')
          .replace(/(-\d{4})\d+?$/, '$1')
      }

      // Aplicar máscaras
      document.getElementById('r-cpf').addEventListener('input', (e) => {
        e.target.value = maskCPF(e.target.value)
      })

      document.getElementById('r-phone').addEventListener('input', (e) => {
        e.target.value = maskPhone(e.target.value)
      })

      // Toggle password visibility
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.dataset.target
          const input = document.getElementById(targetId)
          const type = input.type === 'password' ? 'text' : 'password'
          input.type = type
          
          const label = type === 'password' ? 'Mostrar senha' : 'Ocultar senha'
          btn.setAttribute('aria-label', label)
        })
      })

      // Validação client-side
      function showError(fieldId, message) {
        const field = document.getElementById(fieldId)
        const errorDiv = document.getElementById(`${fieldId.replace('r-', '')}-error`)
        field.classList.add('input-error')
        errorDiv.textContent = message
        errorDiv.classList.add('show')
      }

      function clearError(fieldId) {
        const field = document.getElementById(fieldId)
        const errorDiv = document.getElementById(`${fieldId.replace('r-', '')}-error`)
        field.classList.remove('input-error')
        errorDiv.classList.remove('show')
      }

      function clearAllErrors() {
        document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'))
        document.querySelectorAll('.field-error').forEach(el => el.classList.remove('show'))
      }

      function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)
      }

      function validateCPF(cpf) {
        cpf = cpf.replace(/\D/g, '')
        return cpf.length === 11
      }

      function validatePhone(phone) {
        phone = phone.replace(/\D/g, '')
        return phone.length >= 10
      }

      // Submissão do formulário
      document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault()
        clearAllErrors()

        const name = document.getElementById('r-name').value.trim()
        const email = document.getElementById('r-email').value.trim()
        const password = document.getElementById('r-pass').value
        const passwordConfirm = document.getElementById('r-pass-confirm').value
        const cpf = document.getElementById('r-cpf').value
        const phone = document.getElementById('r-phone').value

        let hasError = false

        // Validações
        if (!name) {
          showError('r-name', 'Nome é obrigatório')
          hasError = true
        }

        if (!email) {
          showError('r-email', 'E-mail é obrigatório')
          hasError = true
        } else if (!validateEmail(email)) {
          showError('r-email', 'E-mail inválido')
          hasError = true
        }

        if (!password) {
          showError('r-pass', 'Senha é obrigatória')
          hasError = true
        } else if (password.length < 6) {
          showError('r-pass', 'Senha deve ter pelo menos 6 caracteres')
          hasError = true
        }

        if (!passwordConfirm) {
          showError('r-pass-confirm', 'Confirme a senha')
          hasError = true
        } else if (password !== passwordConfirm) {
          showError('r-pass-confirm', 'Senhas não coincidem')
          hasError = true
        }

        if (!cpf) {
          showError('r-cpf', 'CPF é obrigatório')
          hasError = true
        } else if (!validateCPF(cpf)) {
          showError('r-cpf', 'CPF inválido (11 dígitos)')
          hasError = true
        }

        if (!phone) {
          showError('r-phone', 'Telefone é obrigatório')
          hasError = true
        } else if (!validatePhone(phone)) {
          showError('r-phone', 'Telefone inválido')
          hasError = true
        }

        if (hasError) {
          toaster.error('Por favor, corrija os erros no formulário')
          return
        }

        // Enviar para API
        const btn = document.getElementById('register-btn')
        loader.buttonStart(btn, 'Criando conta...')

        try {
          const userData = {
            nome: name,
            email: email,
            senha: password,
            cpf: cpf.replace(/\D/g, ''),
            telefone: phone.replace(/\D/g, ''),
            role: 'Usuario' // Padrão
          }

          await authService.register(userData)
          
          toaster.success('Conta criada com sucesso! Redirecionando...')
          a11y.announce('Conta criada com sucesso', 'polite')
          
          setTimeout(() => {
            window.location.href = 'login.html'
          }, 2000)
        } catch (error) {
          console.error('Erro ao criar conta:', error)
          toaster.error(error.message || 'Erro ao criar conta. Tente novamente.')
          loader.buttonEnd(btn, 'Criar Conta')
        }
      })
    </script>
  </body>
</html>
